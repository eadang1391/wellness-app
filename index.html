<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Escarola Wellness</title>
    <meta name="theme-color" content="#6b8e83">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        :root { 
            --sage: #6b8e83; --cream: #fbfaf5; --dark-sage: #3a504a; 
            --white: #ffffff; --gold: #d4a373; --red: #ef476f;
            --mp-blue: #009ee3; --cash-green: #2a9d8f; --shadow: 0 15px 35px rgba(0,0,0,0.1);
        }
        html, body { margin: 0; padding: 0; background-color: var(--sage); height: 100%; overflow-x: hidden; font-family: 'Quicksand', sans-serif; -webkit-tap-highlight-color: transparent; }
        #app { padding: calc(env(safe-area-inset-top) + 20px) 20px calc(env(safe-area-inset-bottom) + 120px) 20px; min-height: 100vh; box-sizing: border-box; }
        
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; color: white; }
        .logo-img { width: 50px; height: 50px; border-radius: 12px; object-fit: cover; background: white; }
        .card { background: var(--white); border-radius: 30px; padding: 20px; margin-bottom: 15px; box-shadow: var(--shadow); width: 100%; box-sizing: border-box; position: relative; }
        
        /* Botones y Navegaci√≥n */
        button { width: 100%; padding: 14px; border-radius: 25px; border: none; font-weight: 700; cursor: pointer; transition: 0.3s; background: var(--dark-sage); color: white; font-family: 'Quicksand'; }
        .nav-bar { position: fixed; bottom: calc(env(safe-area-inset-bottom) + 20px); left: 20px; right: 20px; background: var(--dark-sage); height: 70px; display: flex; justify-content: space-around; align-items: center; border-radius: 35px; z-index: 1000; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
        .nav-item { color: rgba(255,255,255,0.4); text-align: center; font-size: 10px; cursor: pointer; position: relative; }
        .nav-item.active { color: white; }
        .nav-item span { font-size: 20px; display: block; }
        
        /* Punto de Notificaci√≥n */
        .notification-badge { position: absolute; top: -5px; right: 10px; width: 10px; height: 10px; background: var(--red); border-radius: 50%; border: 2px solid var(--dark-sage); display: none; }
        .unread { font-weight: 700; border-left: 4px solid var(--gold) !important; }

        /* Estilos Chat Window */
        #chat-window { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--cream); z-index: 5000; display: none; flex-direction: column; }
        .chat-header { background: var(--sage); color: white; padding: calc(env(safe-area-inset-top) + 15px) 20px 15px 20px; display: flex; align-items: center; gap: 15px; font-weight: 700; }
        #chat-messages { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 10px; }
        .msg { padding: 10px 15px; border-radius: 20px; max-width: 80%; font-size: 14px; }
        .msg.me { align-self: flex-end; background: var(--sage); color: white; border-bottom-right-radius: 4px; }
        .msg.them { align-self: flex-start; background: white; color: var(--dark-sage); border-bottom-left-radius: 4px; border: 1px solid #eee; }
        .chat-input-area { padding: 10px 20px calc(env(safe-area-inset-bottom) + 10px) 20px; background: white; display: flex; gap: 10px; border-top: 1px solid #eee; }
        
        .hidden { display: none !important; }
        input { width: 100%; padding: 12px 18px; margin: 8px 0; border-radius: 20px; border: 2px solid #f0f0f0; box-sizing: border-box; outline: none; }
    </style>
</head>
<body>

<div id="app">
    <header>
        <div style="display:flex; align-items:center; gap:10px;">
            <img src="logo.png" class="logo-img" onerror="this.src='https://cdn-icons-png.flaticon.com/512/3048/3048398.png'">
            <div>
                <h2 style="margin:0; font-size:17px;">Escarola</h2>
                <div id="user-credits-display" class="hidden" style="font-size:10px; color:var(--gold); font-weight:700;">...</div>
            </div>
        </div>
        <button id="btn-logout" class="hidden" onclick="signOut(auth)" style="width:auto; background:rgba(255,255,255,0.2); font-size:10px;">Salir</button>
    </header>

    <div id="view-auth" class="view hidden">
        <div class="card">
            <h3 id="auth-title" style="text-align:center;">Bienvenida/o</h3>
            <input type="email" id="auth-email" placeholder="Correo">
            <input type="password" id="auth-password" placeholder="Contrase√±a">
            <button id="btn-auth-main">Entrar</button>
        </div>
    </div>

    <div id="view-main" class="view hidden">
        <div id="list-clases"></div>
    </div>

    <div id="view-chats" class="view hidden">
        <h3 style="color:white; margin-left:10px;">Mensajes</h3>
        <div class="card" id="chat-list-container"></div>
    </div>

    <nav id="nav-bottom" class="nav-bar hidden">
        <div class="nav-item active" onclick="switchTab('clases')"><span>üè†</span>Inicio</div>
        <div class="nav-item" onclick="switchTab('chats')">
            <div id="chat-badge" class="notification-badge"></div>
            <span>üí¨</span>Chat
        </div>
    </nav>
</div>

<div id="chat-window">
    <div class="chat-header"><span onclick="closeChat()" style="font-size:24px;">‚Äπ</span> <span id="chat-with-name">...</span></div>
    <div id="chat-messages"></div>
    <div class="chat-input-area">
        <input type="text" id="chat-input" placeholder="Escribe...">
        <button onclick="sendMsg()" style="width:auto;">‚Üë</button>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, collection, addDoc, updateDoc, onSnapshot, query, orderBy, where, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyB7NWc1AIHs9UN73-3YtUFECcXDse2JdJo",
        authDomain: "escarola-wellness.firebaseapp.com",
        projectId: "escarola-wellness",
        storageBucket: "escarola-wellness.firebasestorage.app",
        messagingSenderId: "212255082736",
        appId: "1:212255082736:web:66d144fa90308578b75a35"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    let myData = null, activeChatId = null, chatUnsub = null;

    onAuthStateChanged(auth, async user => {
        if (user) {
            const snap = await getDoc(doc(db, "users", user.uid));
            myData = { ...snap.data(), id: user.uid };
            document.getElementById('view-auth').classList.add('hidden');
            document.querySelectorAll('.nav-bar, #btn-logout').forEach(e => e.classList.remove('hidden'));
            switchTab('clases');
            listenGlobalNotifications();
        } else {
            document.getElementById('view-auth').classList.remove('hidden');
            document.querySelectorAll('.nav-bar, #btn-logout').forEach(e => e.classList.add('hidden'));
        }
    });

    window.switchTab = tab => {
        document.querySelectorAll('.view').forEach(v => v.classList.add('hidden'));
        if (tab === 'clases') {
            document.getElementById('view-main').classList.remove('hidden');
            renderClases();
        } else if (tab === 'chats') {
            document.getElementById('view-chats').classList.remove('hidden');
            loadChatList();
        }
    };

    // --- NOTIFICACIONES ---
    function listenGlobalNotifications() {
        const q = query(collection(db, "chats"), where("participants", "array-contains", myData.id));
        onSnapshot(q, snap => {
            let hasUnread = false;
            snap.forEach(d => {
                const c = d.data();
                const lastRead = c.lastRead?.[myData.id]?.seconds || 0;
                const lastMsg = c.lastMsgTime?.seconds || 0;
                if (lastMsg > lastRead && c.lastSenderId !== myData.id) hasUnread = true;
            });
            document.getElementById('chat-badge').style.display = hasUnread ? 'block' : 'none';
        });
    }

    // --- CHAT LOGIC ---
    window.loadChatList = async () => {
        const container = document.getElementById('chat-list-container');
        container.innerHTML = "Cargando...";
        
        if (myData.role === 'alumno') {
            const snap = await getDocs(query(collection(db, "users"), where("role", "in", ["maestro", "admin"])));
            container.innerHTML = "<p style='font-size:10px; color:gray;'>MAESTROS DISPONIBLES:</p>";
            snap.forEach(d => {
                container.innerHTML += `<div onclick="openChat('${d.id}', '${d.data().name}')" class="card" style="margin-top:10px; padding:15px;"><b>${d.data().name}</b></div>`;
            });
        } else {
            const q = query(collection(db, "chats"), where("participants", "array-contains", myData.id), orderBy("lastMsgTime", "desc"));
            onSnapshot(q, snap => {
                container.innerHTML = "";
                snap.forEach(d => {
                    const c = d.data();
                    const otherName = c.names.find(n => n !== myData.name);
                    const otherId = c.participants.find(p => p !== myData.id);
                    const isUnread = (c.lastMsgTime?.seconds > (c.lastRead?.[myData.id]?.seconds || 0)) && c.lastSenderId !== myData.id;
                    container.innerHTML += `<div onclick="openChat('${otherId}', '${otherName}')" class="card ${isUnread ? 'unread' : ''}" style="margin-top:10px; padding:15px;">
                        <b>${otherName}</b><br><small>${c.lastMsg || ''}</small>
                    </div>`;
                });
            });
        }
    };

    window.openChat = async (id, name) => {
        activeChatId = myData.id < id ? `${myData.id}_${id}` : `${id}_${myData.id}`;
        document.getElementById('chat-with-name').innerText = name;
        document.getElementById('chat-window').style.display = 'flex';
        
        await setDoc(doc(db, "chats", activeChatId), {
            participants: [myData.id, id],
            names: [myData.name, name],
            [`lastRead.${myData.id}`]: serverTimestamp()
        }, { merge: true });

        if (chatUnsub) chatUnsub();
        chatUnsub = onSnapshot(query(collection(db, "chats", activeChatId, "messages"), orderBy("time", "asc")), snap => {
            const box = document.getElementById('chat-messages');
            box.innerHTML = "";
            snap.forEach(d => {
                const m = d.data();
                box.innerHTML += `<div class="msg ${m.senderId === myData.id ? 'me' : 'them'}">${m.text}</div>`;
            });
            box.scrollTop = box.scrollHeight;
        });
    };

    window.closeChat = async () => {
        document.getElementById('chat-window').style.display = 'none';
        if (activeChatId) {
            await updateDoc(doc(db, "chats", activeChatId), { [`lastRead.${myData.id}`]: serverTimestamp() });
        }
        if (chatUnsub) chatUnsub();
    };

    window.sendMsg = async () => {
        const t = document.getElementById('chat-input').value.trim();
        if (!t) return;
        document.getElementById('chat-input').value = "";
        await addDoc(collection(db, "chats", activeChatId, "messages"), { text: t, senderId: myData.id, time: serverTimestamp() });
        await updateDoc(doc(db, "chats", activeChatId), { 
            lastMsg: t, 
            lastMsgTime: serverTimestamp(), 
            lastSenderId: myData.id,
            [`lastRead.${myData.id}`]: serverTimestamp() 
        });
    };

    function renderClases() {
        onSnapshot(query(collection(db, "clases"), orderBy("horario", "asc")), snap => {
            const div = document.getElementById('list-clases'); div.innerHTML = "";
            snap.forEach(d => {
                const c = d.data();
                div.innerHTML += `<div class="card"><b>${c.nombre}</b><br><small>${c.horario}</small></div>`;
            });
        });
    }

    document.getElementById('btn-auth-main').onclick = () => {
        signInWithEmailAndPassword(auth, document.getElementById('auth-email').value, document.getElementById('auth-password').value);
    };
</script>
</body>
</html>
